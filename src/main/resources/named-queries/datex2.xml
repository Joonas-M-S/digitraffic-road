<?xml version="1.0"?>
<entity-mappings
    xmlns="http://java.sun.com/xml/ns/persistence/orm"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://java.sun.com/xml/ns/persistence/orm
        http://java.sun.com/xml/ns/persistence/orm_2_0.xsd"
    version="2.0">
    <named-native-query name="find_latest_import_time">
        <query>
            select max(datex2.import_date) as updated
            from datex2
            where message_type = :messageType
        </query>
    </named-native-query>

    <named-native-query name="find_history_by_situation_id" result-class="fi.livi.digitraffic.tie.data.model.Datex2">
        <query>
            <![CDATA[
            SELECT d.*
            FROM datex2 d
            WHERE EXISTS (
              SELECT NULL
              FROM datex2_situation situation
              INNER JOIN datex2_situation_record record ON record.datex2_situation_id = situation.id
              WHERE situation.datex2_id = d.id
                AND situation.situation_id = :situationId
                AND d.publication_time >= TRUNC(TO_DATE('1.' || :month || '.' || :year, 'DD.MM.YYYY'), 'MONTH')
                AND d.publication_time < LAST_DAY(TO_DATE('1.' || :month || '.' || :year, 'DD.MM.YYYY')) + 1
                AND d.message_type = :messageType
            )
          ]]>
        </query>
        <hint name="org.hibernate.fetchSize" value="1000" />
    </named-native-query>

    <named-native-query name="find_by_situation_id_and_message_type" result-class="fi.livi.digitraffic.tie.data.model.Datex2">
        <query>
            <![CDATA[
            SELECT d.*
            FROM datex2 d
            WHERE d.id in (
                SELECT situation.datex2_id
                FROM datex2_situation situation
                WHERE situation.situation_id = :situationId
            )
            AND message_type = :messageType
            ]]>
        </query>
        <hint name="org.hibernate.fetchSize" value="1000" />
    </named-native-query>

    <named-native-query name="list_roadworks_situation_version_times">
        <query>
            SELECT situation_id, version_time
            FROM (
                    SELECT ROW_NUMBER() OVER (PARTITION BY situation.SITUATION_ID ORDER BY record.version_time DESC) AS rnum
                  , situation.situation_id
                  , record.version_time
                  , record.validy_status
                 FROM DATEX2 d
                 INNER JOIN datex2_situation situation ON situation.datex2_id = d.id
                 INNER JOIN datex2_situation_record record ON record.datex2_situation_id = situation.id
                 WHERE d.message_type = 'ROADWORK'
                 ) d2
             WHERE rnum = 1
        </query>
    </named-native-query>
</entity-mappings>
